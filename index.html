<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>北海道防災ハザードマップ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
 <style>
        body { padding: 0; margin: 0; }
        html, body, #map { height: 100%; width: 100vw; }
        #controls {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); font-size: 14px;
            max-width: 200px;
        }
        .legend { background: white; padding: 5px; line-height: 1.5; }
                body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }

        /* UIパネル */
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 200px;
        }

        .btn-action {
            display: block;
            width: 100%;
            padding: 12px 5px;
            margin-bottom: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-gps { background: #3498db; }

        /* 現在地ピンの点滅アニメーション */
        .current-location-marker {
            background-color: #3498db;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 1; }
            70% { transform: scale(1.3); opacity: 0.3; }
            100% { transform: scale(0.9); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="controls">
    <strong>ハザード表示切替</strong><br>
    <label><input type="checkbox" id="flood"> 洪水浸水想定</label><br>
    <label><input type="checkbox" id="landslide"> 土砂災害警戒区域</label><br>
    <label><input type="checkbox" id="tsunami"> 津波浸水想定</label><hr>
    <button onclick="findNearestShelter()">現在地から一番近い避難所へ</button>
</div>
<div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    // 1. マップの初期化（北海道を中心に設定）
    const map = L.map('map', {
        center: [43.5, 142.5],
        zoom: 7,
        maxBounds: [[41.0, 139.0], [46.0, 149.0]] // 北海道のみに制限
    });

    // 背景地図（国土地理院 標準地図）
       L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

    // 2. ハザードレイヤーの設定（国土地理院タイル）
    const layers = {
        flood: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png', {opacity: 0.7}),
        landslide: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png', {opacity: 0.7}),
        tsunami: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png', {opacity: 0.7})
    };
    
    // チェックボックス連動
    document.querySelectorAll('#controls input').forEach(input => {
        input.addEventListener('change', (e) => {
            if (e.target.checked) layers[e.target.id].addTo(map);
            else map.removeLayer(layers[e.target.id]);
        });
    });

    // 3. 避難所データの読み込み (アップロードされたgeojsonを使用)
    let sheltersLayer;
    fetch('01000_1.geojson')
        .then(response => response.json())
        .then(data => {
            sheltersLayer = L.geoJSON(data, {
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`<strong>${feature.properties["施設・場所名"]}</strong><br>${feature.properties["住所"]}<br><button onclick="startRouting(${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]})">ここへのルートを表示</button>`);
                },
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, { radius: 6, fillColor: "#ff7800", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                }
            }).addTo(map);
        });

    // 4. ルート案内機能
    let routingControl;
    let userLocation;

    map.locate({setView: false, watch: true});
    map.on('locationfound', (e) => {
        userLocation = e.latlng;
        L.marker(e.latlng).addTo(map).bindPopup("現在地").openPopup();
    });

    function startRouting(destLat, destLng) {
        if (!userLocation) {
            alert("現在地が取得できていません。位置情報を許可してください。");
            return;
        }
        if (routingControl) map.removeControl(routingControl);
        
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(userLocation.lat, userLocation.lng),
                L.latLng(destLat, destLng)
            ],
            routeWhileDragging: true,
            language: 'ja',
            createMarker: function() { return null; } // 余計なマーカーを消す
        }).addTo(map);
    }

    function findNearestShelter() {
        if (!userLocation || !sheltersLayer) return;
        let minDist = Infinity;
        let nearest;
        sheltersLayer.eachLayer(layer => {
            let dist = userLocation.distanceTo(layer.getLatLng());
            if (dist < minDist) {
                minDist = dist;
                nearest = layer.getLatLng();
            }
        });
        if (nearest) startRouting(nearest.lat, nearest.lng);
    }
       window.calcRoute = function(destLat, destLng, startLoc = null) {
            if (!startLoc && !userMarker) return alert("先に現在地を取得してください");
            const start = startLoc || userMarker.getLatLng();

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [start, L.latLng(destLat, destLng)],
                lineOptions: { styles: [{ color: '#2ecc71', weight: 6 }] },
                createMarker: () => null, // 余計なマーカーを消す
                addWaypoints: false,
                draggableWaypoints: false,
                show: false // 詳細ナビパネルはスマホだと邪魔なので隠す
            }).addTo(map);
        };

</script>

</body>
</html>
