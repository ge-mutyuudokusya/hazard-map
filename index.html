
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

<title>北海道 防災ハザードマップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
#map { height:100%; }

/* ===== ボトムパネル ===== */
#panel {
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  z-index:1000;
  background:#ffffffee;
  backdrop-filter: blur(6px);
  border-radius:16px 16px 0 0;
  box-shadow:0 -4px 16px rgba(0,0,0,0.25);
  padding:10px 14px calc(10px + env(safe-area-inset-bottom));
}

.panel-header {
  text-align:center;
  font-weight:600;
  padding:6px;
}

/* ===== 折りたたみ ===== */
details {
  margin-top:6px;
}
summary {
  list-style:none;
  cursor:pointer;
  font-weight:600;
  padding:10px;
  background:#f0f0f0;
  border-radius:10px;
  text-align:center;
}
summary::-webkit-details-marker { display:none; }

.hazard-box {
  margin-top:8px;
}

/* ===== トグル ===== */
.toggle {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin:8px 0;
}
.toggle span { font-size:15px; }

.toggle input {
  appearance:none;
  width:46px;
  height:26px;
  background:#ccc;
  border-radius:13px;
  position:relative;
  transition:.2s;
}
.toggle input:checked { background:#3498db; }
.toggle input::after {
  content:"";
  position:absolute;
  width:22px;
  height:22px;
  top:2px;
  left:2px;
  background:#fff;
  border-radius:50%;
  transition:.2s;
}
.toggle input:checked::after { left:22px; }

/* ===== ボタン ===== */
button {
  width:100%;
  margin-top:10px;
  padding:14px;
  font-size:16px;
  font-weight:600;
  background:#e74c3c;
  color:#fff;
  border:none;
  border-radius:12px;
}
button:active { opacity:0.85; }

.route-btn {
  margin-top:6px;
  padding:8px;
  font-size:14px;
  background:#3498db;
  border-radius:8px;
}




/* ===== 流れる文字 ===== */
.flow-text {
  display: inline-block;
  white-space: nowrap;
  padding-left: 100%;
  animation: flow-left 30s linear infinite;
font-size:1.9rem;
}

@keyframes flow-left {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}


.emergency-bar{
  display:flex;
  align-items:center;
  background:#b91c1c;
  color:#fff;
  overflow:hidden;
  height:40px;
  font-weight:700;
  font-family:"Noto Sans JP", sans-serif;
}

.emergency-label{
  background:#7f1d1d;
  padding:0 16px;
  white-space:nowrap;
  font-size:0.9rem;
}

.emergency-marquee{
  flex:1;
  overflow:hidden;
  position:relative;
}

</style>




<div class="emergency-bar">
  <div class="emergency-label">緊急速報</div>

  <div class="emergency-marquee">
      
      <div style="overflow: hidden; width: 100%;">
            <span class="flow-text">日本海側で直下型地震を観測しました。落ち着いて身の安全を確保してください。震度はおおむね5強です。日本海側で津波注意報が発令されています。最新の情報に注意してください。
            </span>
        </div>

       <!-- <marquee direction="left" scrollamount="5">
           右から左へ流れる文字です。
     </marquee> -->
  </div>
</div>




</head>

<body>
<div id="map"></div>

<div id="panel">
  <details>
     <summary>ハザード表示</summary>
  <div class="panel-header">防災操作</div>

  <!-- 折りたたみ -->
  
   
    <div class="hazard-box">
      <div class="toggle">
        <span>洪水</span>
        <input type="checkbox" id="flood">
      </div>
      <div class="toggle">
        <span>土砂災害</span>
        <input type="checkbox" id="landslide">
      </div>
      <div class="toggle">
        <span>津波</span>
        <input type="checkbox" id="tsunami">
      </div>
    </div>

  <button onclick="findNearestShelter()">最寄りの安全な避難所へ</button>
    </details>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>

/* ===== マップ ===== */
const map = L.map('map',{
  center:[43.5,142.5],
  zoom:7,
  maxBounds:[[41,139],[46,149]]
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

/* ===== ハザード ===== */
const hazardLayers = {
  flood: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png',{opacity:0.6}),
  landslide: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',{opacity:0.6}),
  tsunami: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png',{opacity:0.6})
};

document.querySelectorAll('#panel input').forEach(cb=>{
  cb.onchange=()=>{
    cb.checked ? hazardLayers[cb.id].addTo(map)
               : map.removeLayer(hazardLayers[cb.id]);
    drawShelters();
  };
});

/* ===== 現在地 ===== */
let userLatLng,userMarker;
map.locate({watch:true,enableHighAccuracy:true});
map.on('locationfound',e=>{
  userLatLng=e.latlng;
  if(!userMarker){
    userMarker=L.circleMarker(userLatLng,{
      radius:7,color:'#007aff',fillColor:'#007aff',fillOpacity:1
    }).addTo(map).bindPopup("現在地");
    map.setView(userLatLng,14);
  } else userMarker.setLatLng(userLatLng);
});

/* ===== 避難所 ===== */
let shelters=[], sheltersLayer=L.layerGroup().addTo(map);

fetch('01000_1.geojson')
.then(r=>r.json())
.then(d=>{ shelters=d.features; drawShelters(); });

function isShelterAllowed(p){
  if(!p) return true;
  if(tsunami.checked && p["津波対応"]===false) return false;
  if(flood.checked && p["洪水対応"]===false) return false;
  if(landslide.checked && p["土砂対応"]===false) return false;
  return true;
}

function drawShelters(){
  sheltersLayer.clearLayers();
  shelters.forEach(f=>{
    if(!isShelterAllowed(f.properties)) return;
    const lat=f.geometry.coordinates[1];
    const lng=f.geometry.coordinates[0];
    L.circleMarker([lat,lng],{
      radius:6,color:'#333',fillColor:'#ff9800',fillOpacity:0.9
    })
    .bindPopup(`
      <b>${f.properties["施設・場所名"]||"避難所"}</b><br>
      <button class="route-btn" onclick="routeTo(${lat},${lng})">
        この避難所までルート表示
      </button>
    `)
    .addTo(sheltersLayer);
  });
}

/* ===== ルート ===== */
let routing;
function routeTo(lat,lng){
  if(!userLatLng) return alert("現在地未取得");
  if(routing) map.removeControl(routing);
  routing=L.Routing.control({
    waypoints:[userLatLng,L.latLng(lat,lng)],
    createMarker:()=>null,
    addWaypoints:false,
    draggableWaypoints:false,
    show:false
  }).addTo(map);
}

/* ===== 最寄り ===== */
function findNearestShelter(){
  if(!userLatLng) return;
  let nearest,min=Infinity;
  sheltersLayer.eachLayer(l=>{
    const d=userLatLng.distanceTo(l.getLatLng());
    if(d<min){min=d;nearest=l.getLatLng();}
  });
  if(nearest) routeTo(nearest.lat,nearest.lng);
  else alert("近くに避難所がありません");
}
</script>
</body>
</html>
