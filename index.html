<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŒ—æµ·é“ é˜²ç½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #fff;
    }

    #map {
      position: absolute;
      top: 50px; /* header height */
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: #1c1c1c;
      text-align: center;
      line-height: 50px;
      font-weight: bold;
      z-index: 2000;
    }

    .hazard-bar {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    .hazard-btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      color: #fff;
      opacity: 0.6;
    }

    .hazard-btn.active {
      opacity: 1;
      box-shadow: 0 0 10px rgba(255,255,255,0.4);
    }

    .tsunami { background: #005eff; }
    .flood { background: #00bcd4; }
    .landslide { background: #ff9800; }

    .action-bar {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
    }

    .action-bar button {
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 10px;
      border: none;
      background: #2ecc71;
      color: #000;
      font-weight: bold;
    }

  </style>
</head>
<body>

<header id="mode">é€šå¸¸è¡¨ç¤º</header>
<div id="map"></div>

<div class="hazard-bar">
  <button class="hazard-btn tsunami" data-type="tsunami">ğŸŒŠ æ´¥æ³¢</button>
  <button class="hazard-btn flood" data-type="flood">ğŸ’§ æ´ªæ°´</button>
  <button class="hazard-btn landslide" data-type="landslide">â›° åœŸç ‚</button>
</div>

<div class="action-bar">
  <button id="locate">ğŸ“ ç¾åœ¨åœ°</button>
  <button id="route">â¡ æœ€å¯„ã‚Šé¿é›£æ‰€</button>
</div>

<script>
  // --- Map ---
  const map = L.map('map', {
    minZoom: 5,
    maxBounds: [[41,138],[46.5,148]]
  }).setView([43.2, 142.8], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // --- Hazard tiles ---
  const hazardTiles = {
    tsunami: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/tsunami/{z}/{x}/{y}.png', {opacity:0.6}),
    flood: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/flood_l2/{z}/{x}/{y}.png', {opacity:0.6}),
    landslide: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/landslide/{z}/{x}/{y}.png', {opacity:0.6})
  };

  let currentHazard = null;

  // --- Shelter data (official-like sample structure) ---
  const shelters = [];


  fetch('https://motohasystem.github.io/jp-shelter-api/api/v0/emergency/01.json')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(f => {
        if (!f.geometry || f.geometry.type !== 'Point') return;

        const p = f.properties || {};
        const [lng, lat] = f.geometry.coordinates;

        const marker = L.marker([lat, lng]);

        // æ­£ã—ã„ç½å®³ãƒ•ãƒ©ã‚°ï¼ˆå…¬å¼ä»•æ§˜ï¼‰
        marker.hazard = {
          tsunami: p.tsunami === true || p.tsunami === '1',
          flood: p.flood === true || p.flood === '1',
          landslide: p.landslide === true || p.landslide === '1'
        };

        marker.bindPopup(`
          <strong>${p.name || 'åç§°ä¸æ˜'}</strong><br>
          ä½æ‰€: ${p.address || 'ä¸æ˜'}<br>
          æ¨™é«˜: ${p.elevation ?? 'ä¸æ˜'} m<br>
          åå®¹äººæ•°: ${p.capacity ?? 'ä¸æ˜'} äºº<br>
          ğŸŒŠ æ´¥æ³¢: ${marker.hazard.tsunami ? 'â­•' : 'âŒ'}<br>
          ğŸ’§ æ´ªæ°´: ${marker.hazard.flood ? 'â­•' : 'âŒ'}<br>
          â›° åœŸç ‚: ${marker.hazard.landslide ? 'â­•' : 'âŒ'}
        `);

        shelters.push(marker);
        marker.addTo(map);
      });
    })
    .catch(err => {
      alert('é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      console.error(err);
    });
    });

  // --- Hazard filter ---
  document.querySelectorAll('.hazard-btn').forEach(btn => {
    btn.onclick = () => {
      const type = btn.dataset.type;

      document.querySelectorAll('.hazard-btn').forEach(b=>b.classList.remove('active'));
      Object.values(hazardTiles).forEach(t=>map.removeLayer(t));

      if (currentHazard === type) {
        currentHazard = null;
        document.getElementById('mode').innerText = 'é€šå¸¸è¡¨ç¤º';
        shelters.forEach(m => m.setOpacity(1));
        return;
      }

      btn.classList.add('active');
      hazardTiles[type].addTo(map);
      currentHazard = type;
      document.getElementById('mode').innerText = `âš  ${btn.innerText} ç½å®³ãƒ¢ãƒ¼ãƒ‰`;

      shelters.forEach(m => {
        m.setOpacity(m.hazard[type] ? 1 : 0);
      });
    };
  });

  // --- Location & routing ---
  let userMarker, route;

  document.getElementById('locate').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker(latlng).addTo(map).bindPopup('ç¾åœ¨åœ°').openPopup();
      map.setView(latlng, 14);
    });
  };

  document.getElementById('route').onclick = () => {
    if (!userMarker) return alert('ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„');

    const user = userMarker.getLatLng();
    const candidates = shelters.filter(m => !currentHazard || m.hazard[currentHazard]);
    if (!candidates.length) return alert('å¯¾å¿œé¿é›£æ‰€ãŒã‚ã‚Šã¾ã›ã‚“');

    let nearest = candidates[0];
    let dist = map.distance(user, nearest.getLatLng());

    candidates.forEach(m => {
      const d = map.distance(user, m.getLatLng());
      if (d < dist) { dist = d; nearest = m; }
    });

    if (route) map.removeControl(route);
    route = L.Routing.control({
      waypoints: [user, nearest.getLatLng()],
      addWaypoints: false,
      show: false
    }).addTo(map);
  };
</script>
</body>
</html>
