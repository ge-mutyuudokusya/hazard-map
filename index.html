<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>北海道防災ハザードマップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<style>
html, body, #map { height:100%; margin:0; }
#controls{
 position:absolute; top:10px; left:10px; z-index:1000;
 background:#fff; padding:10px; border-radius:8px;
 box-shadow:0 2px 10px rgba(0,0,0,.3);
}
</style>
</head>

<body>
<div id="controls">
<label><input type="checkbox" id="flood"> 洪水</label><br>
<label><input type="checkbox" id="landslide"> 土砂</label><br>
<label><input type="checkbox" id="tsunami"> 津波</label><hr>
<button onclick="findNearestShelter()">最寄り安全避難所</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* =====================
  マップ
===================== */
const map = L.map('map',{center:[43.5,142.5],zoom:7});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* =====================
  災害タイル
===================== */
const hazardTiles = {
 flood:'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png',
 landslide:'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',
 tsunami:'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png'
};

/* =====================
  現在地
===================== */
let userLatLng=null;
map.locate({watch:true,enableHighAccuracy:true});
map.on('locationfound',e=>{
 userLatLng=e.latlng;
});

/* =====================
  タイル座標変換
===================== */
function latLngToTile(lat,lng,z){
 const x=Math.floor((lng+180)/360*Math.pow(2,z));
 const y=Math.floor(
   (1-Math.log(Math.tan(lat*Math.PI/180)+1/Math.cos(lat*Math.PI/180))/Math.PI)/2
   *Math.pow(2,z)
 );
 return {x,y};
}

/* =====================
  災害タイル存在判定
===================== */
function tileExists(url){
 return new Promise(resolve=>{
   const img=new Image();
   img.onload=()=>resolve(true);
   img.onerror=()=>resolve(false);
   img.src=url;
 });
}

/* =====================
  避難所
===================== */
let shelters=[];
let layer=L.layerGroup().addTo(map);

fetch('01000_1.geojson')
.then(r=>r.json())
.then(d=>{
 shelters=d.features;
 drawShelters();
});

async function isSafeShelter(lat,lng){
 const zoom=15;
 const tile=latLngToTile(lat,lng,zoom);

 const checks=[];
 ['flood','landslide','tsunami'].forEach(type=>{
   if(document.getElementById(type).checked){
     const url=hazardTiles[type]
       .replace('{z}',zoom)
       .replace('{x}',tile.x)
       .replace('{y}',tile.y);
     checks.push(tileExists(url));
   }
 });

 const results=await Promise.all(checks);
 return !results.includes(true); // trueが1つでもあれば危険
}

async function drawShelters(){
 layer.clearLayers();

 for(const f of shelters){
   const lat=f.geometry.coordinates[1];
   const lng=f.geometry.coordinates[0];

   const safe=await isSafeShelter(lat,lng);
   if(!safe) continue;

   const m=L.circleMarker([lat,lng],{
     radius:6,fillColor:'#2ecc71',
     fillOpacity:.9,color:'#000'
   }).bindPopup("安全な避難所");
   layer.addLayer(m);
 }
}

/* =====================
  最寄り安全避難所
===================== */
let routing=null;
function findNearestShelter(){
 if(!userLatLng) return alert("現在地未取得");

 let min=Infinity, target=null;
 layer.eachLayer(l=>{
   const d=userLatLng.distanceTo(l.getLatLng());
   if(d<min){min=d; target=l.getLatLng();}
 });

 if(!target) return alert("安全な避難所がありません");

 if(routing) map.removeControl(routi
