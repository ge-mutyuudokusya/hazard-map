<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>åŒ—æµ·é“å…¨åŸŸãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ»é¿é›£ãƒŠãƒ“</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }

        /* UIãƒ‘ãƒãƒ« */
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 200px;
        }

        .btn-action {
            display: block;
            width: 100%;
            padding: 12px 5px;
            margin-bottom: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-gps { background: #3498db; }

        /* ç¾åœ¨åœ°ãƒ”ãƒ³ã®ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .current-location-marker {
            background-color: #3498db;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 1; }
            70% { transform: scale(1.3); opacity: 0.3; }
            100% { transform: scale(0.9); opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <button class="btn-action btn-gps" onclick="findNearestShelter()">ğŸ“ æœ€å¯„ã‚Šã®é¿é›£æ‰€ã‚’æ¢ã™</button>
        <div style="font-size: 11px; color: #666; margin-top: 5px;">
            â€»ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„<br>
            â€»èµ¤ã„ã‚¨ãƒªã‚¢ï¼šãƒã‚¶ãƒ¼ãƒ‰æƒ…å ±
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // --- 1. åˆæœŸè¨­å®š ---
        const map = L.map('map', { zoomControl: false }).setView([43.064, 141.346], 7); // åŒ—æµ·é“å…¨åŸŸ
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // ãƒ™ãƒ¼ã‚¹åœ°å›³ (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // --- 2. ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (å›½åœŸåœ°ç†é™¢) ---
        const hazardLayers = {
            "ğŸŒŠ æ´¥æ³¢": L.tileLayer('https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png', { opacity: 0.6 }),
            "ğŸ’§ æ´ªæ°´": L.tileLayer('https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png', { opacity: 0.6 }),
            "â›°ï¸ åœŸç ‚": L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_dosha_kiken_nadare_data/{z}/{x}/{y}.png', { opacity: 0.6 })
        };
        // åˆæœŸçŠ¶æ…‹ã§å…¨éƒ¨ONã«ã™ã‚‹å ´åˆã¯ .addTo(map) ã‚’ã¤ã‘ã‚‹
        hazardLayers["â›°ï¸ åœŸç ‚"].addTo(map); 
        L.control.layers(null, hazardLayers, { collapsed: false, position: 'topright' }).addTo(map);

        // --- 3. é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º ---
        // æœ¬æ¥ã¯åŒ—æµ·é“ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’APIç­‰ã‹ã‚‰å–å¾—ã—ã¾ã™ãŒã€ã“ã“ã§ã¯å‹•ä½œã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦
        // åŒ—æµ·é“ã®ä¸»è¦ãªé¿é›£æ‰€åœ°ç‚¹ã‚’é…åˆ—åŒ–ã€‚å…¨åŸŸå¯¾å¿œæ™‚ã¯å¤–éƒ¨JSONåŒ–ã‚’æ¨å¥¨ã€‚
                  let sheltersLayer;
    fetch('01000_1.geojson')
        .then(response => response.json())
        .then(data => {
            sheltersLayer = L.geoJSON(data, {
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`<strong>${feature.properties["æ–½è¨­ãƒ»å ´æ‰€å"]}</strong><br>${feature.properties["ä½æ‰€"]}<br><button onclick="startRouting(${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]})">ã“ã“ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º</button>`);
                },
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, { radius: 6, fillColor: "#ff7800", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 });
                }
            }).addTo(map);
        });


        const markers = L.markerClusterGroup();
        const shelterIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/819/819865.png',
            iconSize: [30, 30], iconAnchor: [15, 30]
        });

        sheltersLayer.forEach(s => {
            const m = L.marker([s.lat, s.lng], { icon: shelterIcon })
                       .bindPopup(`<b>${s.name}</b><br><button onclick="calcRoute(${s.lat},${s.lng})">ã“ã“ã¸è¡Œã</button>`);
            markers.addLayer(m);
        });
        map.addLayer(markers);

        // --- 4. GPSã¨æœ€å¯„ã‚Šæ¤œç´¢æ©Ÿèƒ½ ---
        let userMarker, routingControl;

        function findNearestShelter() {
            if (!navigator.geolocation) return alert("GPSéå¯¾å¿œã§ã™");

            navigator.geolocation.getCurrentPosition(pos => {
                const uLat = pos.coords.latitude;
                const uLng = pos.coords.longitude;
                const userLoc = L.latLng(uLat, uLng);

                // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker(userLoc, { className: 'current-location-marker', radius: 10 }).addTo(map);
                
                // åŒ—æµ·é“å†…ã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                if (uLat < 41 || uLat > 46 || uLng < 139 || uLng > 149) {
                    alert("åŒ—æµ·é“å¤–ã«ã„ã‚‹ã‚ˆã†ã§ã™ã€‚åŒ—æµ·é“å†…ã®é¿é›£æ‰€ã‚’æ¤œç´¢ã—ã¾ã™ã€‚");
                }

                // æœ€ã‚‚è¿‘ã„é¿é›£æ‰€ã‚’æ¢ã™
                let nearest = null;
                let minDist = Infinity;

                sheltersLayer.forEach(s => {
                    const dist = userLoc.distanceTo(L.latLng(s.lat, s.lng));
                    if (dist < minDist) {
                        minDist = dist;
                        nearest = s;
                    }
                });

                if (nearest) {
                    map.flyTo([nearest.lat, nearest.lng], 15);
                    setTimeout(() => {
                        calcRoute(nearest.lat, nearest.lng, userLoc);
                        alert(`æœ€å¯„ã‚Šã®ã€Œ${nearest.name}ã€ã¾ã§ã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`);
                    }, 1000);
                }
            }, () => alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"));
        }

        // --- 5. ãƒ«ãƒ¼ãƒˆæç”» ---
        window.calcRoute = function(destLat, destLng, startLoc = null) {
            if (!startLoc && !userMarker) return alert("å…ˆã«ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„");
            const start = startLoc || userMarker.getLatLng();

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [start, L.latLng(destLat, destLng)],
                lineOptions: { styles: [{ color: '#2ecc71', weight: 6 }] },
                createMarker: () => null, // ä½™è¨ˆãªãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆã™
                addWaypoints: false,
                draggableWaypoints: false,
                show: false // è©³ç´°ãƒŠãƒ“ãƒ‘ãƒãƒ«ã¯ã‚¹ãƒãƒ›ã ã¨é‚ªé­”ãªã®ã§éš ã™
            }).addTo(map);
        };

    </script>
</body>
</html>
