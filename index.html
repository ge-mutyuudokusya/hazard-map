<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>åŒ—æµ·é“ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</title>

<!-- PWA / å…¨ç”»é¢ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

#map {
  height: 100%;
}

/* æ³¨æ„æ›¸ã */
.notice {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.65);
  color: white;
  padding: 6px 10px;
  font-size: 11px;
  border-radius: 10px;
  z-index: 1000;
}

/* ã‚¹ãƒãƒ›ä¸‹éƒ¨æ“ä½œãƒãƒ¼ */
.control-panel {
  position: fixed;
  bottom: env(safe-area-inset-bottom);
  left: 0;
  width: 100%;
  background: rgba(255,255,255,0.95);
  padding: 10px 6px;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.25);
  display: flex;
  justify-content: space-around;
  z-index: 1000;
}

.control-panel label,
.control-panel button {
  font-size: 12px;
  text-align: center;
}

.control-panel button {
  border: none;
  border-radius: 10px;
  padding: 6px 10px;
  background: #007aff;
  color: white;
}
</style>
</head>

<body>
<div id="map"></div>

<div class="notice">
  â€»å‚è€ƒæƒ…å ±ã§ã™ã€‚é¿é›£ã¯è‡ªæ²»ä½“ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„
</div>

<div class="control-panel">
  <label><input type="checkbox" id="flood" checked> æ´ªæ°´</label>
  <label><input type="checkbox" id="tsunami" checked> æ´¥æ³¢</label>
  <label><input type="checkbox" id="landslide" checked> åœŸç ‚</label>
  <label><input type="checkbox" id="evacuation" checked> é¿é›£æ‰€</label>
  <button id="locateBtn">ğŸ“ ç¾åœ¨åœ°</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- åœ°å›³åˆæœŸåŒ–ï¼ˆåŒ—æµ·é“ï¼‰ ---
const map = L.map('map', {
  zoomControl: true,
  minZoom: 6,
  maxZoom: 16
}).setView([43.5, 142.7], 7);

// ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—
L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: 'Â© å›½åœŸåœ°ç†é™¢'
}).addTo(map);

// --- ãƒã‚¶ãƒ¼ãƒ‰ãƒ¬ã‚¤ãƒ¤ãƒ¼ ---
const floodLayer = L.tileLayer(
  'https://disaportal.gsi.go.jp/data/raster/01_flood_l2_shinsuishin/{z}/{x}/{y}.png',
  { opacity: 0.6 }
);

const tsunamiLayer = L.tileLayer(
  'https://disaportal.gsi.go.jp/data/raster/04_tsunami/{z}/{x}/{y}.png',
  { opacity: 0.6 }
);

const landslideLayer = L.tileLayer(
  'https://disaportal.gsi.go.jp/data/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',
  { opacity: 0.6 }
);

// é¿é›£æ‰€ï¼ˆå›½åœŸåœ°ç†é™¢ å®‰å®šç‰ˆï¼‰
fetch('https://disaportal.gsi.go.jp/hazardmap_data/evacuation/evacuation.geojson')
  .then(res => res.json())
  .then(data => {
    evacuationLayer.addData(data);
    console.log('é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', data.features.length);
  })
  .catch(err => alert('é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“'));

// é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿å–å¾—
fetch('https://www.gsi.go.jp/common/000221878.geojson')
  .then(res => res.json())
  .then(data => evacuationLayer.addData(data));

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡
document.getElementById('flood').onchange = e =>
  e.target.checked ? map.addLayer(floodLayer) : map.removeLayer(floodLayer);

document.getElementById('tsunami').onchange = e =>
  e.target.checked ? map.addLayer(tsunamiLayer) : map.removeLayer(tsunamiLayer);

document.getElementById('landslide').onchange = e =>
  e.target.checked ? map.addLayer(landslideLayer) : map.removeLayer(landslideLayer);

document.getElementById('evacuation').onchange = e =>
  e.target.checked ? map.addLayer(evacuationLayer) : map.removeLayer(evacuationLayer);

// --- ç¾åœ¨åœ° ---
let currentMarker, accuracyCircle, routeLine;

document.getElementById('locateBtn').onclick = () => {
  if (!navigator.geolocation) {
    alert('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      if (currentMarker) {
        map.removeLayer(currentMarker);
        map.removeLayer(accuracyCircle);
        if (routeLine) map.removeLayer(routeLine);
      }

      currentMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup('ç¾åœ¨åœ°');

      accuracyCircle = L.circle([lat, lng], {
        radius: acc,
        color: 'blue',
        fillOpacity: 0.15
      }).addTo(map);

      map.setView([lat, lng], 14);

      // æœ€å¯„ã‚Šé¿é›£æ‰€
      let nearest = null;
      let minDist = Infinity;

      evacuationLayer.eachLayer(layer => {
        const d = map.distance([lat, lng], layer.getLatLng());
        if (d < minDist) {
          minDist = d;
          nearest = layer;
        }
      });

      if (nearest) {
        nearest.openPopup();
        routeLine = L.polyline(
          [[lat, lng], nearest.getLatLng()],
          { dashArray: '5,5', color: 'red' }
        ).addTo(map);
      }
    },
    () => alert('ä½ç½®æƒ…å ±ã®å–å¾—ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ'),
    { enableHighAccuracy: true }
  );
};
</script>
</body>
</html>
