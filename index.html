<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>åŒ—æµ·é“ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼†é¿é›£ãƒŠãƒ“</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        
        /* åœ°å›³ã‚’ç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤º */
        #map { height: 100vh; width: 100%; }

        /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .gps-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 24px;
            text-align: center;
        }

        /* èª¬æ˜ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å¾®èª¿æ•´ */
        .leaflet-popup-content { font-size: 14px; }
        .route-btn {
            display: block;
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="gps-btn" onclick="getMyLocation()">ğŸ“</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        // 1. åœ°å›³ã®åˆæœŸåŒ–ï¼ˆåˆæœŸä½ç½®ï¼šåŒ—æµ·é“ æœ­å¹Œä»˜è¿‘ï¼‰
        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’èª¿æ•´ã—ã¦åŒ—æµ·é“å…¨ä½“ãŒè¦‹ãˆã‚„ã™ã„ã‚ˆã†ã«è¨­å®š
        const map = L.map('map').setView([43.068661, 141.350755], 12);

        // 2. ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆæ¨™æº–åœ°å›³ï¼‰
        const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // 3. å›½åœŸåœ°ç†é™¢ ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®šç¾©
        // æ´¥æ³¢æµ¸æ°´æƒ³å®š
        const tsunamiLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png', {
            opacity: 0.7,
            attribution: 'å›½åœŸåœ°ç†é™¢:æ´¥æ³¢æµ¸æ°´æƒ³å®š'
        });

        // æ´ªæ°´æµ¸æ°´æƒ³å®š
        const floodLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png', {
            opacity: 0.7,
            attribution: 'å›½åœŸåœ°ç†é™¢:æ´ªæ°´æµ¸æ°´æƒ³å®š'
        });

        // åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸ
        const landslideLayer = L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_dosha_kiken_nadare_data/{z}/{x}/{y}.png', {
            opacity: 0.7,
            attribution: 'å›½åœŸåœ°ç†é™¢:åœŸç ‚ç½å®³'
        });

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¿½åŠ 
        const overlayMaps = {
            "ğŸŒŠ æ´¥æ³¢æµ¸æ°´æƒ³å®š": tsunamiLayer,
            "ğŸ’§ æ´ªæ°´æµ¸æ°´æƒ³å®š": floodLayer,
            "â›°ï¸ åœŸç ‚ç½å®³åŒºåŸŸ": landslideLayer
        };
        L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);


        // 4. é¿é›£å ´æ‰€ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ï¼ˆå®Ÿéš›ã¯DBã‚„CSVã‹ã‚‰èª­ã¿è¾¼ã‚€éƒ¨åˆ†ï¼‰
        // ã“ã“ã§ã¯æœ­å¹Œå‘¨è¾ºã®æ•°ã‚«æ‰€ã‚’ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ç™»éŒ²
        const shelters = [
            { name: "å¤§é€šå…¬åœ’ (ä¸€æ™‚é¿é›£å ´æ‰€)", lat: 43.060, lng: 141.353 },
            { name: "æœ­å¹Œå¸‚å½¹æ‰€ (ç½å®³å¯¾ç­–æœ¬éƒ¨)", lat: 43.062, lng: 141.354 },
            { name: "ä¸­å³¶å…¬åœ’ (åºƒåŸŸé¿é›£å ´æ‰€)", lat: 43.045, lng: 141.356 },
            { name: "åŒ—æµ·é“å¤§å­¦ (åºƒåŸŸé¿é›£å ´æ‰€)", lat: 43.071, lng: 141.340 }
        ];

        // ãƒ«ãƒ¼ãƒˆæ¤œç´¢ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å¤‰æ•°
        let routingControl = null;
        let currentPos = null;

        // é¿é›£å ´æ‰€ã‚¢ã‚¤ã‚³ãƒ³ã®ä½œæˆ
        const shelterIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1673/1673221.png', // ãƒ•ãƒªãƒ¼ã®é¿é›£æ‰€ã£ã½ã„ã‚¢ã‚¤ã‚³ãƒ³
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«é…ç½®
        shelters.forEach(site => {
            const marker = L.marker([site.lat, site.lng], {icon: shelterIcon}).addTo(map);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­èº«ï¼ˆãƒ«ãƒ¼ãƒˆæ¤œç´¢ãƒœã‚¿ãƒ³ä»˜ãï¼‰
            const popupContent = `
                <b>${site.name}</b><br>
                <button class="route-btn" onclick="calcRoute(${site.lat}, ${site.lng})">ã“ã“ã¸é¿é›£ï¼ˆãƒ«ãƒ¼ãƒˆè¡¨ç¤ºï¼‰</button>
            `;
            marker.bindPopup(popupContent);
        });


        // 5. ç¾åœ¨åœ°å–å¾—ã¨è¡¨ç¤ºæ©Ÿèƒ½
        function getMyLocation() {
            if (!navigator.geolocation) {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    currentPos = L.latLng(lat, lng);

                    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
                    L.circleMarker(currentPos, {
                        color: 'blue',
                        fillColor: '#30f',
                        fillOpacity: 0.5,
                        radius: 10
                    }).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();

                    // åœ°å›³ã‚’ç¾åœ¨åœ°ã«ç§»å‹•
                    map.setView(currentPos, 14);
                },
                (error) => {
                    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            );
        }

        // 6. ãƒ«ãƒ¼ãƒˆè¨ˆç®—æ©Ÿèƒ½
        window.calcRoute = function(destLat, destLng) {
            if (!currentPos) {
                alert("å…ˆã«å³ä¸‹ã®ãƒœã‚¿ãƒ³ğŸ“ã‚’æŠ¼ã—ã¦ã€ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚");
                getMyLocation(); // è‡ªå‹•ã§å–å¾—ã‚’è©¦ã¿ã‚‹
                return;
            }

            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Œã°æ¶ˆã™
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã®å®Ÿè¡Œï¼ˆOSRMã‚’åˆ©ç”¨ï¼‰
            routingControl = L.Routing.control({
                waypoints: [
                    currentPos,
                    L.latLng(destLat, destLng)
                ],
                routeWhileDragging: false,
                language: 'ja', // æ—¥æœ¬èªåŒ–
                show: false, // ãƒ†ã‚­ã‚¹ãƒˆã®æ¡ˆå†…æ¿ã‚’éš ã™ï¼ˆã‚¹ãƒãƒ›ã§é‚ªé­”ã«ãªã‚‹ãŸã‚ï¼‰
                lineOptions: {
                    styles: [{color: 'red', opacity: 0.7, weight: 5}]
                },
                createMarker: function() { return null; } // ãƒ«ãƒ¼ãƒˆä¸Šã®å§‹ç‚¹çµ‚ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’é‡è¤‡ã•ã›ãªã„
            }).addTo(map);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
            map.closePopup();
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä½ç½®æƒ…å ±å–å¾—ã‚’ä¿ƒã™ï¼ˆä»»æ„ï¼‰
        // getMyLocation(); 

    </script>
</body>
</html>
