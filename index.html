<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>åŒ—æµ·é“ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</title>

<meta name="theme-color" content="#000000">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
#map { height: 100%; }

.notice {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.65);
  color: white;
  padding: 6px 10px;
  font-size: 11px;
  border-radius: 10px;
  z-index: 1000;
}

.control-panel {
  position: fixed;
  bottom: env(safe-area-inset-bottom);
  left: 0;
  width: 100%;
  background: rgba(255,255,255,0.95);
  padding: 10px 6px;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.25);
  display: flex;
  justify-content: space-around;
  z-index: 1000;
}

.control-panel label,
.control-panel button { font-size: 12px; }

.control-panel button {
  border: none;
  border-radius: 10px;
  padding: 6px 10px;
  background: #007aff;
  color: white;
}
</style>
</head>

<body>
<div id="map"></div>

<div class="notice">
  â€»å‚è€ƒæƒ…å ±ã§ã™ã€‚é¿é›£ã¯è‡ªæ²»ä½“ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„
</div>

<div class="control-panel">
  <label><input type="checkbox" id="flood" checked> æ´ªæ°´</label>
  <label><input type="checkbox" id="tsunami" checked> æ´¥æ³¢</label>
  <label><input type="checkbox" id="landslide" checked> åœŸç ‚</label>
  <label><input type="checkbox" id="evacuation" checked> é¿é›£å ´æ‰€</label>
  <button id="locateBtn">ğŸ“ ç¾åœ¨åœ°</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ====================
// åœ°å›³åˆæœŸåŒ–
// ====================
const map = L.map('map', { minZoom: 6, maxZoom: 16 })
  .setView([43.5, 142.7], 7);

L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: 'Â© å›½åœŸåœ°ç†é™¢'
}).addTo(map);

// ====================
// ãƒã‚¶ãƒ¼ãƒ‰
// ====================
const floodLayer = L.tileLayer(
  'https://disaportal.gsi.go.jp/data/raster/01_flood_l2_shinsuishin/{z}/{x}/{y}.png',
  { opacity: 0.6 }
);

const tsunamiLayer = L.tileLayer(
  'https://disaportal.gsi.go.jp/data/raster/04_tsunami/{z}/{x}/{y}.png',
  { opacity: 0.6, minZoom: 5, maxZoom: 13 }
);

const landslideLayer = L.tileLayer(
  'https://disaportal.gsi.go.jp/data/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',
  { opacity: 0.6 }
);

// ====================
// é¿é›£å ´æ‰€
// ====================
const evacuationLayer = L.layerGroup();

// åˆæœŸè¡¨ç¤º
[floodLayer, tsunamiLayer, landslideLayer, evacuationLayer].forEach(l => l.addTo(map));

// ====================
// åŒ—æµ·é“BBOX
// ====================
const HOKKAIDO = {
  minLat: 41.3, maxLat: 45.7,
  minLng: 139.3, maxLng: 148.9
};

// ====================
// é¿é›£å ´æ‰€å–å¾—ï¼ˆç¢ºå®Ÿç‰ˆï¼‰
// ====================
fetch('https://disaportal.gsi.go.jp/data/vector/evacuation/evacuation.geojson')
  .then(r => r.json())
  .then(data => {
    data.features.forEach(f => {
      if (!f.geometry || f.geometry.type !== 'Point') return;

      const [lng, lat] = f.geometry.coordinates;
      if (
        lat < HOKKAIDO.minLat || lat > HOKKAIDO.maxLat ||
        lng < HOKKAIDO.minLng || lng > HOKKAIDO.maxLng
      ) return;

      const name =
        f.properties?.name ||
        f.properties?.æŒ‡å®šç·Šæ€¥é¿é›£å ´æ‰€ ||
        'é¿é›£å ´æ‰€';

      const marker = L.circleMarker([lat, lng], {
        radius: 6,
        color: '#0055ff',
        fillColor: '#3399ff',
        fillOpacity: 0.9
      }).bindPopup(name);

      evacuationLayer.addLayer(marker);
    });
  });

// ====================
// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
// ====================
document.getElementById('flood').onchange = e =>
  e.target.checked ? map.addLayer(floodLayer) : map.removeLayer(floodLayer);

document.getElementById('tsunami').onchange = e =>
  e.target.checked ? map.addLayer(tsunamiLayer) : map.removeLayer(tsunamiLayer);

document.getElementById('landslide').onchange = e =>
  e.target.checked ? map.addLayer(landslideLayer) : map.removeLayer(landslideLayer);

document.getElementById('evacuation').onchange = e =>
  e.target.checked ? map.addLayer(evacuationLayer) : map.removeLayer(evacuationLayer);

// ====================
// ç¾åœ¨åœ° & æœ€å¯„ã‚Šé¿é›£å ´æ‰€
// ====================
let currentMarker, accuracyCircle, routeLine;

document.getElementById('locateBtn').onclick = () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude, accuracy } = pos.coords;

    [currentMarker, accuracyCircle, routeLine].forEach(l => l && map.removeLayer(l));

    currentMarker = L.marker([latitude, longitude])
      .addTo(map).bindPopup('ç¾åœ¨åœ°').openPopup();

    accuracyCircle = L.circle([latitude, longitude], {
      radius: accuracy, fillOpacity: 0.15
    }).addTo(map);

    map.setView([latitude, longitude], 14);

    let nearest = null;
    let minDist = Infinity;

    evacuationLayer.eachLayer(layer => {
      const d = map.distance([latitude, longitude], layer.getLatLng());
      if (d < minDist) {
        minDist = d;
        nearest = layer;
      }
    });

    if (!nearest) return;

    routeLine = L.polyline(
      [[latitude, longitude], nearest.getLatLng()],
      { color: 'red', dashArray: '6,4' }
    ).addTo(map);

    nearest.openPopup();
  });
};
</script>
</body>
</html>
